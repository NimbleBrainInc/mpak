# Default values for mpak Helm chart.
# Override these in values.production.yaml or via --set flags.

# -- Global settings ----------------------------------------------------------
global:
  # Image pull secrets for private registries
  imagePullSecrets: []
  # Override the namespace
  namespace: ""

# -- Registry API Server ------------------------------------------------------
registry:
  replicaCount: 2

  image:
    repository: ghcr.io/nimblebraininc/mpak-registry
    tag: ""  # Defaults to Chart.appVersion
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 3200

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: "1"
      memory: 512Mi

  # Autoscaling
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Liveness and readiness probes
  livenessProbe:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Environment variables (non-secret)
  env:
    NODE_ENV: production
    PORT: "3200"
    HOST: "0.0.0.0"
    STORAGE_TYPE: s3
    MAX_BUNDLE_SIZE_MB: "50"
    SCANNER_ENABLED: "true"

  # Node selector, tolerations, affinity
  nodeSelector: {}
  tolerations: []
  affinity: {}

  # Pod annotations
  podAnnotations: {}

  # Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop: [ALL]

# -- Web Frontend --------------------------------------------------------------
web:
  replicaCount: 2

  image:
    repository: ghcr.io/nimblebraininc/mpak-web
    tag: ""  # Defaults to Chart.appVersion
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 8080

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 500m
      memory: 128Mi

  livenessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 5
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 3
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  nodeSelector: {}
  tolerations: []
  affinity: {}

  podAnnotations: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101  # nginx-unprivileged UID
    fsGroup: 101

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false  # nginx needs to write tmp files
    capabilities:
      drop: [ALL]

# -- Ingress -------------------------------------------------------------------
ingress:
  enabled: false
  className: nginx
  annotations: {}
    # cert-manager.io/cluster-issuer: letsencrypt-prod
    # nginx.ingress.kubernetes.io/proxy-body-size: "100m"

  # Registry API host
  registry:
    host: registry.mpak.dev
    tls:
      enabled: true
      secretName: mpak-registry-tls

  # Web UI host
  web:
    host: mpak.dev
    tls:
      enabled: true
      secretName: mpak-web-tls

# -- ConfigMap (non-secret configuration) --------------------------------------
config:
  # CORS origins (comma-separated)
  corsOrigins: "https://mpak.dev"
  # S3 region
  s3Region: us-east-1

# -- Secrets -------------------------------------------------------------------
# These should be created externally (e.g., via ExternalSecrets, SealedSecrets,
# or kubectl create secret). Set existingSecret to reference a pre-existing secret.
secrets:
  # Use an existing secret instead of creating one from the chart
  existingSecret: ""

  # Only used if existingSecret is empty (NOT recommended for production)
  databaseUrl: ""
  clerkSecretKey: ""
  clerkPublishableKey: ""
  s3Bucket: ""
  s3AccessKeyId: ""
  s3SecretAccessKey: ""
  cloudfrontDomain: ""
  cloudfrontKeyPairId: ""
  cloudfrontPrivateKeyBase64: ""
  scannerCallbackSecret: ""

# -- Persistent Volume Claim (for local storage mode) -------------------------
persistence:
  enabled: false
  storageClass: ""
  accessModes:
    - ReadWriteOnce
  size: 50Gi
  annotations: {}

# -- PostgreSQL (subchart or external) -----------------------------------------
# Set to true to deploy PostgreSQL as part of this chart.
# For production, use an external managed database (RDS, Cloud SQL, etc.)
postgresql:
  enabled: false
  # If using an external database, set the URL in secrets.databaseUrl
